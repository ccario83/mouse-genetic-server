//Flash any notices
<% flash.each do |alert_type, notice| %>
flash_notice("<%= notice %>", "<%= alert_type %>");
<% end %>

// Fill in previous form values so they can be corrected
$("#new-datafile").html("<%= escape_javascript(render :partial => 'users/datafile_form', :locals => { user: @user, datafile: @datafile }) %>");

// If there are any errors, hijack the simple_form_for html to display them (simple_form_for wasn't doing this!)
<% if not @datafile.valid? %>
	<% @datafile.errors.messages.each do |field, errors| %>
		<% if errors.any? %>
			<% if field == :filename %><% field = :datafile %><% end %>
			var field = $('#new-datafile #datafile_<%= field %>');
			field.parent().parent().addClass('error');
			<% errors.each do |error| %>
				field.after("<p class='help-block'><%= error %></p>")
			<% end %>
		<% end %>
	<% end %>
<% else %>
	// Otherwise hide the new form modal and update the datafile and job panels 
	$("#new-datafile").modal('hide');
	update_div('#datafile-panel');
	update_div('#job-panel');
<% end %>

// Attach some file upload functionality
$('#new-datafile :file').change(function()
{
	var file = this.files[0];
	if(file.name.length < 1 || file.size < 1) 
	{
		alert("The file appears empty.");
		$('#new-datafile :submit').attr('disabled','disabled');
	}
	else if(file.size > 1048576)
	{
		alert("Please limit file uploads to 1Mb.");
		$('#new-datafile :submit').attr('disabled','disabled');
	}
	else
	{
		$('#new-datafile :submit').removeAttr('disabled','');
		$('#new-datafile :submit').live('click', function(){ ajax_form_submit('#new-datafile'); return false; });
	}
});
// Reattach the :remote=>true form submit functionality
attach_submit('#new-datafile');
$("[id^=edit-datafile]").each(function() { attach_submit(this.id); });

// Reattach chosen handler
$('#datafile_group_ids').chosen({ min_search_term_length: 2 });
$('#datafile-new').chosen({ min_search_term_length: 2 });